USE [BANK]
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[Estado_cuenta](
	[UUID] [int] IDENTITY(1,1) NOT NULL,
	[Operacion] int REFERENCES OPERACION (UUID) NOT NULL,
	[Cuota] [money] NOT NULL,
	[Fecha] [date] NOT NULL,
	[Saldo_principal] [money] NOT NULL,
	[Saldo_amortizado] [money] NOT NULL,
	[Interes_pagado] [money] NOT NULL,
	[Fecha_Ultimo_Pago] [date] NOT NULL,
	[Fecha_Proximo_Pago] [date] NOT NULL,
	[Plazo_restante] [int] NOT NULL,
	[Dias_atraso] [int] NOT NULL,
	[Dias_SUGEF_atraso] [int] NOT NULL,
	[Mora_financiera] [money] NULL,
	[Mora_legal] [money] NULL,
	[Cuotas_vencidas] [int] NOT NULL,
	[Monto_Gestion_Mora] [money] NULL DEFAULT 0 CHECK (Monto_Gestion_Mora>=0),
	[Monto_Gestion_Cobro_Judicial] [money] NULL DEFAULT 0 CHECK (Monto_Gestion_Cobro_Judicial>=0),
	[Monto_Gestion] [money] NULL DEFAULT 0 CHECK (Monto_Gestion>=0),
 CONSTRAINT [PK_Estado_cuenta] PRIMARY KEY CLUSTERED 
(
	[UUID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

CREATE INDEX INDEX_Estado_cuenta on Estado_cuenta (	
    [Operacion]
)
GO

Create view view_estado_cuenta(
	UUID,	
	Operacion,
	Cliente,
	Moneda,
	Monto_Original,
	Cuota, 
	Fecha, 
	Saldo_principal,
	Saldo_amortizado,
	Interes_pagado,
	Fecha_Ultimo_Pago,
	Fecha_Proximo_Pago,
	Plazo_restante,
	Dias_atraso,
	Dias_SUGEF_atraso,
	Mora_financiera,
	Mora_legal,
	Cuotas_vencidas,
	Monto_Gestion_Mora,
	Monto_Gestion_Cobro_Judicial,
	Monto_Gestion
) AS
SELECT
	e.UUID,	
	e.Operacion,
	o.CLIENTE,
	o.Moneda,
	o.MONTO,
	e.Cuota, 
	e.Fecha, 
	e.Saldo_principal,
	e.Saldo_amortizado,
	e.Interes_pagado,
	e.Fecha_Ultimo_Pago,
	e.Fecha_Proximo_Pago,
	e.Plazo_restante,
	e.Dias_atraso,
	e.Dias_SUGEF_atraso,
	e.Mora_financiera,
	e.Mora_legal,
	e.Cuotas_vencidas,
	e.Monto_Gestion_Mora,
	e.Monto_Gestion_Cobro_Judicial,
	e.Monto_Gestion
FROM
	OPERACION O
	join Estado_cuenta e on o.UUID = e.OPERACION
	join MONEDA m on o.MONEDA = m.UUID
GO

--Ejemplo
INSERT INTO Estado_cuenta ( Cuota, 
                            Operacion,
							Fecha, 
							Saldo_principal,
							Saldo_amortizado,
							Interes_pagado,
							Fecha_Ultimo_Pago,
							Fecha_Proximo_Pago,
							Plazo_restante,
							Dias_atraso,
							Dias_SUGEF_atraso,
							Mora_financiera,
							Mora_legal,
							Cuotas_vencidas,
							Monto_Gestion_Mora,
							Monto_Gestion_Cobro_Judicial,
							Monto_Gestion)  
	VALUES
    (1, 1, '2020-09-04',1045039.42,38675.58,18965.01,'2020-09-04','2020-10-04',22,0,0,0,0,0,0,0,0),
    (1, 2, '2020-09-12',2356781.89,64812.11,42377.9,'2020-09-12','2020-10-12',28,0,0,0,0,0,0,0,0),
    (1, 3, '2020-09-14',1971978.35,42198.65,35248.1,'2020-09-14','2020-10-14',34,0,0,0,0,0,0,0,0),
    (1, 4, '2020-09-07',1889994.41,45638.59,33873.58,'2020-09-07','2020-10-07',31,0,0,0,0,0,0,0,0),
    (1, 5, '2020-09-02',4635853.67,181400.33,84301.95,'2020-09-02','2020-10-02',21,0,0,0,0,0,0,0,0),
    (1, 6, '2020-09-12',4757149.84,136944.16,85646.65,'2020-09-12','2020-10-12',27,0,0,0,0,0,0,0,0),
    (1, 7, '2020-09-04',3748256.23,118726.77,67672.2,'2020-09-04','2020-10-04',25,0,0,0,0,0,0,0,0),
    (1, 8, '2020-09-10',2229136.14,98192.86,40728.26,'2020-09-10','2020-10-10',19,0,0,0,0,0,0,0,0),
    (1, 9, '2020-09-16',4375650.38,171218.62,79570.21,'2020-09-16','2020-10-16',21,0,0,0,0,0,0,0,0),
    (1, 10, '2020-09-12',1070931.12,29450.88,19256.69,'2020-09-12','2020-10-12',28,0,0,0,0,0,0,0,0),
    (1, 11, '2020-09-04',4631181.81,139744.19,83491.21,'2020-09-04','2020-10-04',26,0,0,0,0,0,0,0,0),
    (1, 12, '2020-09-15',3906657.76,172087.24,71378.04,'2020-09-15','2020-10-15',19,0,0,0,0,0,0,0,0),
    (1, 13, '2020-09-05',3503354.85,188336.15,64604.59,'2020-09-05','2020-10-05',16,0,0,0,0,0,0,0,0),
    (1, 14, '2020-09-15',3314905.47,116267.53,60045.53,'2020-09-15','2020-10-15',23,0,0,0,0,0,0,0,0),
    (1, 15, '2020-09-01',3613770.92,91027.08,64833.97,'2020-09-01','2020-10-01',30,0,0,0,0,0,0,0,0),
    (1, 16, '2020-09-12',3830572.22,149889.78,69658.09,'2020-09-12','2020-10-12',21,0,0,0,0,0,0,0,0),
    (1, 17, '2020-09-11',3093616.2,114490.8,56141.87,'2020-09-11','2020-10-11',22,0,0,0,0,0,0,0,0),
    (1, 18, '2020-09-15',2343135.85,52154.15,41917.58,'2020-09-15','2020-10-15',33,0,0,0,0,0,0,0,0),
    (1, 19, '2020-09-14',966361.05,42567.95,17656.26,'2020-09-14','2020-10-14',19,0,0,0,0,0,0,0,0),
    (1, 20, '2020-09-16',3943321.59,197713.41,72468.11,'2020-09-16','2020-10-16',17,0,0,0,0,0,0,0,0),
    (1, 21, '2020-09-10',3837129.05,115783.95,69175.98,'2020-09-10','2020-10-10',26,0,0,0,0,0,0,0,0),
    (1, 22, '2020-09-09',3296965.54,145230.46,60238.43,'2020-09-09','2020-10-09',19,0,0,0,0,0,0,0,0),
    (1, 23, '2020-09-10',1757507.27,77417.73,32111.19,'2020-09-10','2020-10-10',19,0,0,0,0,0,0,0,0),
    (1, 24, '2020-09-02',4751751.25,136788.75,85549.45,'2020-09-02','2020-10-02',27,0,0,0,0,0,0,0,0),
    (1, 25, '2020-09-02',2434047.53,130851.47,44885.73,'2020-09-02','2020-10-02',16,0,0,0,0,0,0,0,0),
    (1, 26, '2020-09-14',2068159.16,44256.84,36967.28,'2020-09-14','2020-10-14',34,0,0,0,0,0,0,0,0),
    (1, 27, '2020-09-05',2096630.8,66411.2,37853.24,'2020-09-05','2020-10-05',25,0,0,0,0,0,0,0,0),
    (1, 28, '2020-09-05',3548688.16,97589.84,63809.87,'2020-09-05','2020-10-05',28,0,0,0,0,0,0,0,0),
    (1, 29, '2020-09-15',2266106.39,50439.61,40539.56,'2020-09-15','2020-10-15',33,0,0,0,0,0,0,0,0),
    (1, 30, '2020-09-16',3453071.24,127793.76,62665.14,'2020-09-16','2020-10-16',22,0,0,0,0,0,0,0,0),
    (1, 31, '2020-09-02',3610806.64,103944.36,65008.14,'2020-09-02','2020-10-02',27,0,0,0,0,0,0,0,0),
    (1, 32, '2020-09-08',1019573.06,22693.94,18239.67,'2020-09-08','2020-10-08',33,0,0,0,0,0,0,0,0),
    (1, 33, '2020-09-08',2585190.65,129618.35,47509.16,'2020-09-08','2020-10-08',17,0,0,0,0,0,0,0,0),
    (1, 34, '2020-09-05',1808398.1,90670.9,33233.71,'2020-09-05','2020-10-05',17,0,0,0,0,0,0,0,0),
    (1, 35, '2020-09-10',1905920.93,40785.07,34067.36,'2020-09-10','2020-10-10',34,0,0,0,0,0,0,0,0),
    (1, 36, '2020-09-14',1603048.2,37146.8,28703.41,'2020-09-14','2020-10-14',32,0,0,0,0,0,0,0,0),
    (1, 37, '2020-09-04',2601336.3,62815.7,46622.66,'2020-09-04','2020-10-04',31,0,0,0,0,0,0,0,0),
    (1, 38, '2020-09-05',2903036.73,79834.27,52200.24,'2020-09-05','2020-10-05',28,0,0,0,0,0,0,0,0),
    (1, 39, '2020-09-15',36248477.2,1700914.8,664114.36,'2020-09-15','2020-10-15',18,0,0,0,0,0,0,0,0),
    (1, 40, '2020-09-11',10747365.03,420542.97,195438.39,'2020-09-11','2020-10-11',21,0,0,0,0,0,0,0,0),
    (1, 41, '2020-09-11',36310033.43,876795.57,650769.51,'2020-09-11','2020-10-11',31,0,0,0,0,0,0,0,0),
    (1, 42, '2020-08-31',42078873.52,1557285.48,763632.78,'2020-08-31','2020-09-30',22,0,0,0,0,0,0,0,0),
    (1, 43, '2020-09-13',17754264.91,379926.09,317348.34,'2020-09-13','2020-10-13',34,0,0,0,0,0,0,0,0),
    (1, 44, '2020-09-02',34239459.38,1140271.62,619145.29,'2020-09-02','2020-10-02',24,0,0,0,0,0,0,0,0),
    (1, 45, '2020-09-06',12442912.11,300464.89,223009.1,'2020-09-06','2020-10-06',31,0,0,0,0,0,0,0,0),
    (1, 46, '2020-09-01',47387801.38,1098098.62,848503.25,'2020-09-01','2020-10-01',32,0,0,0,0,0,0,0,0),
    (1, 47, '2020-09-03',35853622.64,738243.36,640357.66,'2020-09-03','2020-10-03',35,0,0,0,0,0,0,0,0),
    (1, 48, '2020-08-31',23957323,758853,432533.08,'2020-08-31','2020-09-30',25,0,0,0,0,0,0,0,0)